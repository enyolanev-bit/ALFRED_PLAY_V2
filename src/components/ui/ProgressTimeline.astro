---
/**
 * ProgressTimeline — Barre de progression fixe en haut de l'écran.
 * - Barre accent qui grandit de 0% à 100% au scroll global.
 * - 7 dots correspondant aux décennies, avec tooltip au hover.
 * - Le dot actif est en couleur accent, les autres en gris.
 * - Label de la décennie active avec crossfade au changement.
 * - Discret : opacity 0.6 par défaut, 1 au hover.
 * - Mobile : dots masqués, barre + label uniquement.
 */

interface Props {
  labels: string[];
  titles?: string[];
}

const { labels, titles = [] } = Astro.props;
---

<div class="progress-timeline" id="progress-timeline" aria-hidden="true">
  <div class="progress-timeline__bar">
    <div class="progress-timeline__fill" id="progress-fill"></div>
  </div>
  <div class="progress-timeline__dots">
    {labels.map((label, i) => (
      <button
        class="progress-timeline__dot"
        data-progress-dot={i}
        data-decade-target={label}
        type="button"
        aria-label={`Aller à ${label}`}
      >
        <span class="progress-timeline__tooltip">{label}</span>
      </button>
    ))}
  </div>
  <div class="progress-timeline__label" id="progress-label"></div>
</div>

<!-- Données des titres pour le script client -->
<script
  id="progress-timeline-data"
  type="application/json"
  set:html={JSON.stringify(labels.map((label, i) => ({
    label,
    title: titles[i] || '',
  })))}
/>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initProgressTimeline() {
    const fill = document.getElementById('progress-fill');
    const dots = document.querySelectorAll('[data-progress-dot]');
    const sections = document.querySelectorAll('.section-decade');
    const label = document.getElementById('progress-label');

    if (!fill || !sections.length) return;

    // Charger les données des décennies
    const dataEl = document.getElementById('progress-timeline-data');
    /** @type {{ label: string, title: string }[]} */
    let decadeData = [];
    try {
      decadeData = JSON.parse(dataEl?.textContent || '[]');
    } catch { /* silencieux */ }

    /** @type {number} Index de la décennie active (-1 = aucune) */
    let currentActiveIndex = -1;

    // Barre de progression globale — 0% à 100% du scroll total
    gsap.to(fill, {
      scrollTrigger: {
        trigger: document.body,
        start: 'top top',
        end: 'bottom bottom',
        scrub: 0.3,
      },
      width: '100%',
      ease: 'none',
    });

    // Activer le dot correspondant à la section visible
    sections.forEach((section, i) => {
      if (!dots[i]) return;

      ScrollTrigger.create({
        trigger: section,
        start: 'top 50%',
        end: 'bottom 50%',
        onEnter: () => setActiveDot(i),
        onEnterBack: () => setActiveDot(i),
      });
    });

    // Clic sur un dot → scroll vers la section
    dots.forEach((dot, i) => {
      dot.addEventListener('click', () => {
        const target = sections[i];
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    function setActiveDot(activeIndex) {
      if (activeIndex === currentActiveIndex) return;

      const previousIndex = currentActiveIndex;
      currentActiveIndex = activeIndex;

      dots.forEach((dot, i) => {
        const wasActive = previousIndex === i;
        const isActive = activeIndex === i;

        dot.classList.toggle('is-active', isActive);

        // Micro-animation pulse sur le dot qui devient actif
        if (isActive && !wasActive) {
          gsap.fromTo(dot, {
            scale: 1,
          }, {
            scale: 1.8,
            duration: 0.15,
            ease: 'power2.out',
            yoyo: true,
            repeat: 1,
            onComplete: () => {
              // Revenir à la taille active (1.5)
              gsap.set(dot, { scale: 1.5 });
            },
          });
        }
      });

      // Mettre à jour le label avec crossfade
      if (label && decadeData[activeIndex]) {
        const { label: decadeLabel, title } = decadeData[activeIndex];
        const text = title ? `${decadeLabel} — ${title}` : decadeLabel;

        // Crossfade : fade out → changer texte → fade in
        gsap.to(label, {
          opacity: 0,
          duration: 0.15,
          ease: 'power2.in',
          onComplete: () => {
            label.textContent = text;
            gsap.to(label, {
              opacity: 1,
              duration: 0.3,
              ease: 'power2.out',
            });
          },
        });
      }
    }
  }

  // Lancer quand le DOM est prêt
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProgressTimeline);
  } else {
    initProgressTimeline();
  }
</script>

<style>
  .progress-timeline {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    height: 20px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    opacity: 0.6;
    transition: opacity var(--duration-fast, 200ms) var(--ease-in-out, cubic-bezier(0.76, 0, 0.24, 1));
  }

  .progress-timeline:hover {
    opacity: 1;
  }

  /* Barre de progression */
  .progress-timeline__bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: transparent;
  }

  .progress-timeline__fill {
    height: 100%;
    width: 0%;
    background: var(--color-accent, #E63946);
    border-radius: 0 2px 2px 0;
  }

  /* Conteneur des dots */
  .progress-timeline__dots {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    pointer-events: none;
  }

  /* Dot individuel */
  .progress-timeline__dot {
    position: relative;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-text-muted, #48484A);
    border: none;
    padding: 0;
    cursor: pointer;
    pointer-events: all;
    transition: background var(--duration-fast, 200ms) var(--ease-in-out, cubic-bezier(0.76, 0, 0.24, 1));
  }

  .progress-timeline__dot:hover {
    transform: scale(1.8);
    background: var(--color-accent-hover, #FF4D5A);
  }

  .progress-timeline__dot.is-active {
    background: var(--color-accent, #E63946);
    transform: scale(1.5);
  }

  /* Label de la décennie active */
  .progress-timeline__label {
    position: absolute;
    top: 6px;
    right: 16px;
    font-family: var(--font-display, 'Space Grotesk', sans-serif);
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--color-text-primary, #F5F5F7);
    opacity: 0;
    white-space: nowrap;
    letter-spacing: 0.03em;
    pointer-events: none;
  }

  /* Tooltip au hover */
  .progress-timeline__tooltip {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-display, 'Space Grotesk', sans-serif);
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--color-text-primary, #F5F5F7);
    background: var(--color-bg-elevated, #141414);
    border: 1px solid var(--color-border, rgba(255, 255, 255, 0.08));
    border-radius: 4px;
    padding: 2px 6px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--duration-fast, 200ms) var(--ease-in-out, cubic-bezier(0.76, 0, 0.24, 1));
  }

  .progress-timeline__dot:hover .progress-timeline__tooltip {
    opacity: 1;
  }

  /* Mobile : masquer les dots, garder barre + label */
  @media (max-width: 767px) {
    .progress-timeline__dots {
      display: none;
    }

    .progress-timeline__label {
      right: 12px;
      top: 5px;
      font-size: 0.65rem;
    }
  }
</style>
